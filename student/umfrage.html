<!DOCTYPE html>
<html lang=de>
<link rel="stylesheet" href="../lib/basic.css">
<script src="../auth.js"></script>
<script src="../lib/basic.js"></script>
<script src="../other/skills.js"></script>
<script src="../other/skilltree.js"></script>
	
<Body>
<div id="kurs"> 
</div>

<div id="frage"> 
</div>

<div id="antworttext"> 

</div>

<div id="weiterbutton"> 
	<button onclick="goToNextScreen()">Weiter</button>
</div>

<div id="closebutton"> 
	<button onclick="goToMainscreen()">X</button>
</div>

</body> 

<style>
	#closebutton{
		position: fixed;
		top: 10px;
		left: 10px;
	}
	
	#weiterbutton{
		position: fixed;
		bottom: 20%;
		left: 50%;
		transform: translateX(-50%);
	}
	#frage{
		position: fixed;
		top: 25%;
		left: 50%;
		transform: translateX(-50%);
	}
	#kurs{
		position: fixed;
		top: 5%;
		left: 50%;
		transform: translateX(-50%);
	}
	#antworttext{
		position: fixed;
		top: 40%;
		left: 50%;
		transform: translateX(-50%);
		text-align: center;
	}
</style>

<script>
	const couchDB = new CouchDB();
	//setUserData(couchDB).then(alert);
	getId("frage").innerHTML=getURLArgsMap();
	var seitenindex = 0;
	var antworten = null;
	var kurslaenge = 0;
	
	async function setData(position){
		const kurs = await getCourse();
		if(!kurs){
			return null;
		}
		const kurslabel = getId("kurs");
		const fragenlabel = getId("frage");
		const aktuellefrage = kurs.questions[position];
		
		kurslabel.innerHTML = kurs.title;
		fragenlabel.innerHTML = aktuellefrage.title;
		
		const antwortfeld = getId("antworttext");
		if(aktuellefrage.type == "text"){
			antwortfeld.innerHTML = `
			<textarea class="input"></textarea>
			`
		}else if(aktuellefrage.type == "scala"){
			antwortfeld.innerHTML = `
			auf einer skala von 1 bis 5: <br>
			<input type="range" min="1" max="5" class="input"></input>
			`
		}else if(aktuellefrage.type == "emoji"){
			
		}
		
		if(antworten == null){
			kurslaenge = kurs.questions.length;
			setUserData(couchDB).then(alert);
			antworten = [];
			for(var i = 0; i < kurs.questions.length; i++){
				antworten.push(null);
			}
		}
		
		
	}
	setData(seitenindex);

	async function getCourse(){
		const args = getURLArgsMap();
		const coursename = args.course;
		if(!coursename){
			return null;
		}
		const kurs = await couchDB.get("course:" + coursename);
		if(!kurs){
			return null;
		}
		return kurs;
	}
	
	async function setCourseAnswer(answer) {
		const args = getURLArgsMap();
		const coursename = args.course;
		if (!coursename) return null;
		const kurs = await couchDB.get("course:" + coursename);
		if (!kurs) return null;

		kurs.result.push(answer);

		await couchDB.set("course:" + coursename, kurs);

		return kurs;
	}
	
	function goToMainscreen(){
		location.href = "./uebersicht.html?user="+ userData.name;
	}
	
	async function goToNextScreen(){
		const antwortfeld = getId("antworttext");
		const wert = antwortfeld.querySelector(".input").value;
		const isTextField = wert.tagName == "TEXTAREA";
		if(isTextField){
			antworten[seitenindex] = wert;
		}else{
			antworten[seitenindex] = parseInt(wert);
		}
		seitenindex++;
		if(seitenindex == kurslaenge){
			setCourseAnswer(antworten);
			//bitte hier den link zu der zusammenfassung einrichten
			//location.href = "./uebersicht.html?user="+ userData.name;
			return
		}
		
		setData(seitenindex);
	}
	
	
	
</script>

</html>